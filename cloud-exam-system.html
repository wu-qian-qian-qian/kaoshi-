<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº‘ç«¯è€ƒè¯•ç³»ç»Ÿ v1.8</title>
    <!-- å†…è”æ ·å¼ï¼Œé¿å…å¤–éƒ¨æ–‡ä»¶å†²çª -->
    <style>
        /* åŸºç¡€æ ·å¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            color: #2d3748;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        h1 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 2.5em;
            font-weight: 600;
        }

        .version {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.6em;
            font-weight: 500;
        }

        nav {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            color: #4a5568;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: #edf2f7;
            border-color: #cbd5e0;
            transform: translateY(-2px);
        }

        .nav-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .panel {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .panel.active {
            display: block;
        }

        .panel-header {
            margin-bottom: 30px;
            text-align: center;
        }

        .panel-header h2 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 1.8em;
            font-weight: 600;
        }

        .panel-header p {
            color: #718096;
            font-size: 1.1em;
        }

        /* äº‘ç«¯é…ç½®æ ·å¼ */
        .cloud-config {
            max-width: 800px;
            margin: 0 auto;
        }

        .config-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .config-section h3 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 1.4em;
            font-weight: 600;
        }

        .config-steps {
            margin: 20px 0;
        }

        .step {
            display: flex;
            align-items: flex-start;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .step-number {
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .step-content {
            flex: 1;
        }

        .step-content p {
            margin: 5px 0;
            color: #4a5568;
        }

        .step-content a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }

        .step-content a:hover {
            text-decoration: underline;
        }

        .step-content code {
            background: #e2e8f0;
            padding: 4px 8px;
            border-radius: 4px;
            font-family: monospace;
            color: #2d3748;
            font-size: 0.9em;
        }

        .config-form {
            margin-top: 30px;
            padding: 20px;
            background: #f7fafc;
            border-radius: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3748;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #718096;
            color: white;
        }

        .btn-secondary:hover {
            background: #4a5568;
            transform: translateY(-2px);
        }

        .config-status {
            text-align: center;
            margin-top: 20px;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 15px 25px;
            background: white;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .status-icon {
            font-size: 20px;
        }

        .status-text {
            font-weight: 600;
            color: #4a5568;
        }

        .cloud-indicator {
            background: #e6fffa;
            color: #234e52;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        /* æ¶ˆæ¯æç¤ºæ ·å¼ */
        .message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        .message.success {
            background: #48bb78;
        }

        .message.error {
            background: #f56565;
        }

        .message.info {
            background: #4299e1;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* è€ƒè¯•ç®¡ç†æ ·å¼ */
        .exam-management, .question-management {
            margin-bottom: 30px;
        }

        .exam-form {
            background: #f8fafc;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .exam-list {
            margin-top: 20px;
        }

        .exam-item {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .exam-item:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .exam-item.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .exam-item h4 {
            margin-bottom: 10px;
            color: #2d3748;
        }

        .exam-item p {
            margin: 5px 0;
            color: #718096;
            font-size: 0.9em;
        }

        .current-exam-info {
            background: #f8fafc;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .exam-actions {
            margin-top: 15px;
        }

        .exam-actions .btn {
            margin-right: 10px;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-danger:hover {
            background: #e53e3e;
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-success:hover {
            background: #38a169;
        }

        .btn-warning {
            background: #ed8936;
            color: white;
        }

        .btn-warning:hover {
            background: #dd6b20;
        }

        .excel-import {
            background: #f8fafc;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .import-info {
            margin-bottom: 15px;
        }

        .import-info ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .import-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .question-form {
            background: #f8fafc;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .fixed-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .option-item {
            background: #e2e8f0;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            font-weight: 600;
            color: #4a5568;
        }

        .questions-list {
            margin-top: 20px;
        }

        .question-item {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .question-number {
            font-weight: 600;
            color: #2d3748;
        }

        .question-content {
            margin-bottom: 10px;
            color: #4a5568;
            line-height: 1.5;
        }

        .question-answer {
            color: #48bb78;
            font-weight: 600;
        }

        .results-list {
            margin-top: 15px;
        }

        .result-item {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .exam-stats {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stat-item {
            text-align: center;
        }

        .stat-label {
            font-size: 12px;
            color: #718096;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 600;
            color: #2d3748;
        }

        .average-score {
            color: #3182ce;
        }

        .question-accuracy {
            color: #38a169;
        }

        .result-info {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .result-info span {
            color: #4a5568;
            font-size: 0.9em;
        }

        .result-time {
            color: #718096;
            font-size: 0.8em;
        }

        /* åˆ†ææ¨¡æ€æ¡†æ ·å¼ */
        .analysis-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 1200px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            background: #667eea;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.4em;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .analysis-actions {
            margin-bottom: 20px;
            text-align: right;
        }

        .analysis-table-container {
            overflow-x: auto;
        }

        .analysis-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .analysis-table th,
        .analysis-table td {
            border: 1px solid #e2e8f0;
            padding: 12px 8px;
            text-align: left;
            vertical-align: top;
        }

        .analysis-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #2d3748;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .question-cell {
            max-width: 300px;
            word-wrap: break-word;
            font-weight: 500;
        }

        .correct-answer {
            background: #c6f6d5;
            color: #22543d;
            font-weight: 600;
            text-align: center;
        }

        .student-answer {
            text-align: center;
            font-weight: 500;
        }

        .student-answer.correct {
            background: #c6f6d5;
            color: #22543d;
        }

        .student-answer.incorrect {
            background: #fed7d7;
            color: #742a2a;
        }

        .question-accuracy-cell {
            background: #e6fffa;
            color: #234e52;
            font-weight: 600;
            text-align: center;
            font-size: 14px;
        }

        .exam-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .btn-info {
            background: #4299e1;
            color: white;
        }

        .btn-info:hover {
            background: #3182ce;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            header {
                padding: 20px;
            }

            h1 {
                font-size: 2em;
            }

            nav {
                flex-direction: column;
                align-items: center;
            }

            .nav-btn {
                width: 200px;
            }

            .panel {
                padding: 20px;
            }

            .config-section {
                padding: 20px;
            }

            .step {
                flex-direction: column;
                text-align: center;
            }

            .step-number {
                margin: 0 auto 10px;
            }

            .form-actions {
                flex-direction: column;
            }

            .fixed-options {
                grid-template-columns: 1fr;
            }

            .result-info {
                flex-direction: column;
                gap: 5px;
            }

            .exam-actions {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            .exam-actions .btn {
                margin-right: 0;
            }
        }
    </style>
    <!-- SheetJSåº“ç”¨äºExcelæ–‡ä»¶è§£æ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>äº‘ç«¯è€ƒè¯•ç³»ç»Ÿ <span class="version">v1.8</span></h1>
            <nav>
                <button id="cloudConfigBtn" class="nav-btn active">äº‘ç«¯é…ç½®</button>
                <button id="adminBtn" class="nav-btn">ç®¡ç†åå°</button>
                <button id="studentBtn" class="nav-btn">å­¦ç”Ÿè€ƒè¯•</button>
                <button id="resultsBtn" class="nav-btn">æŸ¥çœ‹ç»“æœ</button>
            </nav>
        </header>

        <!-- äº‘ç«¯é…ç½®é¢æ¿ -->
        <div id="cloudConfigPanel" class="panel active">
            <div class="panel-header">
                <h2>ğŸŒ äº‘ç«¯é…ç½®</h2>
                <p>é…ç½®äº‘ç«¯æ•°æ®å­˜å‚¨ï¼Œè®©æ‰€æœ‰äººé€šè¿‡é“¾æ¥éƒ½èƒ½è®¿é—®ç›¸åŒæ•°æ®</p>
            </div>
            
            <div class="cloud-config">
                <div class="config-section">
                    <h3>JSONBin.io é…ç½®ï¼ˆæ¨èï¼‰</h3>
                    <div class="config-steps">
                        <div class="step">
                            <div class="step-number">1</div>
                            <div class="step-content">
                                <p>è®¿é—® <a href="https://jsonbin.io/" target="_blank">https://jsonbin.io/</a></p>
                                <p>ç‚¹å‡» "Create Bin" åˆ›å»ºæ–°çš„æ•°æ®å­˜å‚¨</p>
                            </div>
                        </div>
                        <div class="step">
                            <div class="step-number">2</div>
                            <div class="step-content">
                                <p>åœ¨å†…å®¹æ¡†ä¸­è¾“å…¥ï¼š</p>
                                <code>{"exams":[],"results":[]}</code>
                            </div>
                        </div>
                        <div class="step">
                            <div class="step-number">3</div>
                            <div class="step-content">
                                <p>ç‚¹å‡» "Create" åˆ›å»ºBin</p>
                                <p>å¤åˆ¶ Bin URL å’Œ Secret Key</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="config-form">
                        <div class="form-group">
                            <label for="binUrl">Bin URLï¼š</label>
                            <input type="text" id="binUrl" placeholder="https://api.jsonbin.io/v3/b/...">
                        </div>
                        <div class="form-group">
                            <label for="secretKey">Secret Keyï¼š</label>
                            <input type="text" id="secretKey" placeholder="æ‚¨çš„Secret Key">
                        </div>
                        <div class="form-actions">
                            <button id="testConnectionBtn" class="btn btn-secondary">æµ‹è¯•è¿æ¥</button>
                            <button id="saveConfigBtn" class="btn btn-primary">ä¿å­˜é…ç½®</button>
                        </div>
                    </div>
                </div>
                
                <div class="config-status">
                    <div id="connectionStatus" class="status-indicator">
                        <span class="status-icon">âšª</span>
                        <span class="status-text">æœªè¿æ¥</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç®¡ç†åå°é¢æ¿ -->
        <div id="adminPanel" class="panel">
            <div class="panel-header">
                <h2>ç®¡ç†åå°</h2>
                <div class="cloud-indicator">
                    <span id="cloudStatus">ğŸŒ äº‘ç«¯æ¨¡å¼</span>
                </div>
            </div>

            <!-- è€ƒè¯•ç®¡ç† -->
            <div class="exam-management">
                <h3>è€ƒè¯•ç®¡ç†</h3>
                <div class="exam-form">
                    <div class="form-group">
                        <label for="examName">è€ƒè¯•åç§°ï¼š</label>
                        <input type="text" id="examName" placeholder="ä¾‹å¦‚ï¼š10æœˆç¬¬ä¸€æ¬¡è€ƒè¯•">
                    </div>
                    <div class="form-group">
                        <label for="examCodes">å…è®¸çš„è€ƒå·ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰ï¼š</label>
                        <textarea id="examCodes" placeholder="001&#10;002&#10;003"></textarea>
                    </div>
                    <button id="createExamBtn" class="btn btn-primary">åˆ›å»ºæ–°è€ƒè¯•</button>
                </div>

                <div class="exam-list">
                    <h4>ç°æœ‰è€ƒè¯•</h4>
                    <div id="examsList">
                        <!-- è€ƒè¯•åˆ—è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                </div>
            </div>

            <!-- é¢˜ç›®ç®¡ç† -->
            <div class="question-management">
                <h3>é¢˜ç›®ç®¡ç†</h3>
                <div class="current-exam-info">
                    <div id="currentExamInfo">
                        <p>è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè€ƒè¯•</p>
                    </div>
                    <div class="exam-actions">
                        <button id="publishExamBtn" class="btn btn-success" disabled>å‘å¸ƒè€ƒè¯•</button>
                        <button id="unpublishExamBtn" class="btn btn-warning" disabled>å–æ¶ˆå‘å¸ƒ</button>
                        <button id="deleteExamBtn" class="btn btn-danger" disabled>åˆ é™¤è€ƒè¯•</button>
                    </div>
                </div>

                <!-- Excelå¯¼å…¥åŠŸèƒ½ -->
                <div class="excel-import">
                    <h3>Excelæ‰¹é‡å¯¼å…¥</h3>
                    <div class="import-controls">
                        <div class="import-info">
                            <p><strong>Excelæ ¼å¼è¦æ±‚ï¼š</strong></p>
                            <ul>
                                <li>ç¬¬ä¸€åˆ—ï¼šåºå·</li>
                                <li>ç¬¬äºŒåˆ—ï¼šé¢˜ç›®å†…å®¹</li>
                                <li>ç¬¬ä¸‰åˆ—ï¼šæ­£ç¡®ç­”æ¡ˆï¼ˆé€šè¿‡/è‡ªè§/é™æµ/ä¸‹æ¶ï¼‰</li>
                            </ul>
                            <p><strong>å›ºå®šé€‰é¡¹ï¼š</strong>Aï¼šé€šè¿‡ï¼›Bï¼šè‡ªè§ï¼›Cï¼šé™æµï¼›Dï¼šä¸‹æ¶</p>
                        </div>
                        <div class="import-actions">
                            <button id="downloadTemplateBtn" class="btn btn-secondary">ä¸‹è½½Excelæ¨¡æ¿</button>
                            <input type="file" id="excelFileInput" accept=".xlsx,.xls" style="display: none;">
                            <button id="importExcelBtn" class="btn btn-primary">é€‰æ‹©Excelæ–‡ä»¶å¯¼å…¥</button>
                        </div>
                    </div>
                    <div id="importResult" class="import-result" style="display: none;"></div>
                </div>

                <!-- æ‰‹åŠ¨æ·»åŠ é¢˜ç›® -->
                <div class="question-form">
                    <h3>æ‰‹åŠ¨æ·»åŠ é¢˜ç›®</h3>
                    <form id="questionForm">
                        <div class="form-group">
                            <label for="questionText">é¢˜ç›®å†…å®¹ï¼š</label>
                            <textarea id="questionText" placeholder="è¯·è¾“å…¥é¢˜ç›®å†…å®¹" required></textarea>
                        </div>
                        <div class="fixed-options">
                            <div class="option-item">Aï¼šé€šè¿‡</div>
                            <div class="option-item">Bï¼šè‡ªè§</div>
                            <div class="option-item">Cï¼šé™æµ</div>
                            <div class="option-item">Dï¼šä¸‹æ¶</div>
                        </div>
                        <div class="form-group">
                            <label for="correctAnswer">æ­£ç¡®ç­”æ¡ˆï¼š</label>
                            <select id="correctAnswer" name="correctAnswer" required>
                                <option value="">è¯·é€‰æ‹©æ­£ç¡®ç­”æ¡ˆ</option>
                                <option value="é€šè¿‡">é€šè¿‡</option>
                                <option value="è‡ªè§">è‡ªè§</option>
                                <option value="é™æµ">é™æµ</option>
                                <option value="ä¸‹æ¶">ä¸‹æ¶</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">æ·»åŠ é¢˜ç›®</button>
                    </form>
                </div>

                <div class="questions-list">
                    <h3>é¢˜ç›®åˆ—è¡¨</h3>
                    <div id="questionsList">
                        <!-- é¢˜ç›®åˆ—è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                </div>
            </div>
        </div>

        <!-- å­¦ç”Ÿè€ƒè¯•é¢æ¿ -->
        <div id="studentPanel" class="panel">
            <div class="panel-header">
                <h2>å­¦ç”Ÿè€ƒè¯•</h2>
            </div>
            <div class="exam-list">
                <div id="availableExams">
                    <!-- å¯ç”¨è€ƒè¯•åˆ—è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
        </div>

        <!-- ç»“æœæŸ¥çœ‹é¢æ¿ -->
        <div id="resultsPanel" class="panel">
            <div class="panel-header">
                <h2>æŸ¥çœ‹ç»“æœ</h2>
            </div>
            <div class="results-controls">
                <select id="examFilter">
                    <option value="">æ‰€æœ‰è€ƒè¯•</option>
                </select>
                <button id="refreshResultsBtn" class="btn btn-primary">åˆ·æ–°ç»“æœ</button>
                <button id="clearResultsBtn" class="btn btn-danger">æ¸…ç©ºç»“æœ</button>
            </div>
            <div id="resultsList">
                <!-- ç»“æœåˆ—è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>
    </div>

    <script>
        // äº‘ç«¯æ•°æ®ç®¡ç†ç±»
        class CloudDataManager {
            constructor() {
                this.binUrl = null;
                this.secretKey = null;
                this.isConnected = false;
            }

            // è®¾ç½®é…ç½®
            setConfig(binUrl, secretKey) {
                this.binUrl = binUrl;
                this.secretKey = secretKey;
                this.isConnected = !!binUrl && !!secretKey;
                this.saveConfig();
            }

            // ä¿å­˜é…ç½®åˆ°æœ¬åœ°
            saveConfig() {
                localStorage.setItem('cloudConfig', JSON.stringify({
                    binUrl: this.binUrl,
                    secretKey: this.secretKey
                }));
            }

            // åŠ è½½é…ç½®
            loadConfig() {
                const config = localStorage.getItem('cloudConfig');
                if (config) {
                    try {
                        const parsed = JSON.parse(config);
                        this.binUrl = parsed.binUrl;
                        this.secretKey = parsed.secretKey;
                        this.isConnected = !!this.binUrl && !!this.secretKey;
                    } catch (error) {
                        console.error('é…ç½®è§£æå¤±è´¥ï¼š', error);
                        this.binUrl = null;
                        this.secretKey = null;
                        this.isConnected = false;
                    }
                }
            }

            // è·å–æ•°æ®
            async getData() {
                if (!this.isConnected) {
                    throw new Error('æœªé…ç½®äº‘ç«¯å­˜å‚¨');
                }

                try {
                    const response = await fetch(this.binUrl, {
                        headers: {
                            'X-Master-Key': this.secretKey
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    return data.record || { exams: [], results: [] };
                } catch (error) {
                    console.error('è·å–äº‘ç«¯æ•°æ®å¤±è´¥ï¼š', error);
                    throw error;
                }
            }

            // ä¿å­˜æ•°æ®
            async saveData(data) {
                if (!this.isConnected) {
                    throw new Error('æœªé…ç½®äº‘ç«¯å­˜å‚¨');
                }

                try {
                    const response = await fetch(this.binUrl, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Master-Key': this.secretKey
                        },
                        body: JSON.stringify(data)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error('ä¿å­˜äº‘ç«¯æ•°æ®å¤±è´¥ï¼š', error);
                    throw error;
                }
            }

            // æµ‹è¯•è¿æ¥
            async testConnection() {
                console.log('æµ‹è¯•è¿æ¥ - binUrl:', this.binUrl);
                console.log('æµ‹è¯•è¿æ¥ - secretKey:', this.secretKey ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®');
                console.log('æµ‹è¯•è¿æ¥ - isConnected:', this.isConnected);
                
                if (!this.binUrl || !this.secretKey) {
                    throw new Error('è¯·å…ˆè®¾ç½®Bin URLå’ŒSecret Key');
                }
                
                try {
                    await this.getData();
                    this.isConnected = true;
                    console.log('è¿æ¥æµ‹è¯•æˆåŠŸ');
                    return true;
                } catch (error) {
                    this.isConnected = false;
                    console.error('è¿æ¥æµ‹è¯•å¤±è´¥ï¼š', error);
                    throw error;
                }
            }
        }

        // äº‘ç«¯è€ƒè¯•ç³»ç»Ÿ
        class CloudExamSystem {
            constructor() {
                this.version = '1.8.0';
                this.cloudManager = new CloudDataManager();
                this.exams = [];
                this.results = [];
                this.currentQuestionIndex = 0;
                this.studentAnswers = {};
                this.currentStudent = null;
                this.selectedExamId = null;
                this.verifiedExamCode = null;

                this.init();
            }

            async init() {
                this.cloudManager.loadConfig();
                this.bindEvents();
                await this.loadData();
                this.displayExams();
                this.displayResults();
                this.updateCloudStatus();
            }

            async loadData() {
                try {
                    if (this.cloudManager.isConnected) {
                        const data = await this.cloudManager.getData();
                        this.exams = data.exams || [];
                        this.results = data.results || [];
                        console.log('äº‘ç«¯æ•°æ®åŠ è½½æˆåŠŸ');
                    } else {
                        // é™çº§åˆ°æœ¬åœ°å­˜å‚¨
                        this.exams = this.loadExams();
                        this.results = this.loadResults();
                        console.log('ä½¿ç”¨æœ¬åœ°æ•°æ®');
                    }
                } catch (error) {
                    console.error('åŠ è½½æ•°æ®å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®ï¼š', error);
                    this.exams = this.loadExams();
                    this.results = this.loadResults();
                }
            }

            async saveData() {
                try {
                    if (this.cloudManager.isConnected) {
                        const data = {
                            exams: this.exams,
                            results: this.results,
                            version: this.version,
                            lastUpdate: new Date().toISOString()
                        };
                        await this.cloudManager.saveData(data);
                        console.log('äº‘ç«¯æ•°æ®ä¿å­˜æˆåŠŸ');
                    } else {
                        // é™çº§åˆ°æœ¬åœ°å­˜å‚¨
                        this.saveExams();
                        this.saveResults();
                        console.log('æœ¬åœ°æ•°æ®ä¿å­˜æˆåŠŸ');
                    }
                } catch (error) {
                    console.error('ä¿å­˜æ•°æ®å¤±è´¥ï¼Œé™çº§åˆ°æœ¬åœ°å­˜å‚¨ï¼š', error);
                    this.saveExams();
                    this.saveResults();
                }
            }

            // ç»‘å®šäº‹ä»¶
            bindEvents() {
                // é¢æ¿åˆ‡æ¢
                document.getElementById('cloudConfigBtn').addEventListener('click', () => this.showPanel('cloudConfig'));
                document.getElementById('adminBtn').addEventListener('click', () => this.showPanel('admin'));
                document.getElementById('studentBtn').addEventListener('click', () => this.showPanel('student'));
                document.getElementById('resultsBtn').addEventListener('click', () => this.showPanel('results'));

                // äº‘ç«¯é…ç½®
                document.getElementById('testConnectionBtn').addEventListener('click', () => this.testConnection());
                document.getElementById('saveConfigBtn').addEventListener('click', () => this.saveConfig());

                // è€ƒè¯•ç®¡ç†
                document.getElementById('createExamBtn').addEventListener('click', () => this.createExam());
                document.getElementById('deleteExamBtn').addEventListener('click', () => this.deleteExam());
                document.getElementById('publishExamBtn').addEventListener('click', () => this.publishExam());
                document.getElementById('unpublishExamBtn').addEventListener('click', () => this.unpublishExam());

                // é¢˜ç›®ç®¡ç†
                document.getElementById('questionForm').addEventListener('submit', (e) => this.addQuestion(e));
                document.getElementById('downloadTemplateBtn').addEventListener('click', () => this.downloadTemplate());
                document.getElementById('importExcelBtn').addEventListener('click', () => this.triggerFileInput());
                document.getElementById('excelFileInput').addEventListener('change', (e) => this.importExcel(e));

                // ç»“æœç®¡ç†
                document.getElementById('refreshResultsBtn').addEventListener('click', () => this.displayResults());
                document.getElementById('clearResultsBtn').addEventListener('click', () => this.clearResults());
            }

            // äº‘ç«¯é…ç½®ç›¸å…³
            async testConnection() {
                const binUrl = document.getElementById('binUrl').value.trim();
                const secretKey = document.getElementById('secretKey').value.trim();

                if (!binUrl || !secretKey) {
                    this.showMessage('è¯·å¡«å†™å®Œæ•´çš„é…ç½®ä¿¡æ¯ï¼', 'error');
                    return;
                }

                // æ˜¾ç¤ºæµ‹è¯•ä¸­çŠ¶æ€
                this.showMessage('æ­£åœ¨æµ‹è¯•è¿æ¥...', 'info');
                
                this.cloudManager.setConfig(binUrl, secretKey);

                try {
                    await this.cloudManager.testConnection();
                    this.showMessage('è¿æ¥æˆåŠŸï¼äº‘ç«¯å­˜å‚¨å·²é…ç½®', 'success');
                    this.updateCloudStatus();
                    await this.loadData();
                    
                    // ä¿å­˜é…ç½®åˆ°å…¬å¼€æ–‡ä»¶ä¾›å­¦ç”Ÿç«¯ä½¿ç”¨
                    await this.savePublicConfig(binUrl, secretKey);
                } catch (error) {
                    console.error('è¿æ¥æµ‹è¯•è¯¦ç»†é”™è¯¯ï¼š', error);
                    this.showMessage('è¿æ¥å¤±è´¥ï¼š' + error.message, 'error');
                    this.updateCloudStatus();
                }
            }

            // ä¿å­˜å…¬å¼€é…ç½®ä¾›å­¦ç”Ÿç«¯ä½¿ç”¨
            async savePublicConfig(binUrl, secretKey) {
                try {
                    const publicConfig = {
                        binUrl: binUrl,
                        secretKey: secretKey,
                        lastUpdate: new Date().toISOString(),
                        status: "configured"
                    };
                    
                    // ä¿å­˜åˆ°localStorageä½œä¸ºå¤‡ä»½
                    localStorage.setItem('publicCloudConfig', JSON.stringify(publicConfig));
                    
                    // ä¿å­˜åˆ°JSONæ–‡ä»¶ä¾›å­¦ç”Ÿç«¯è¯»å–
                    await this.saveConfigToFile(publicConfig);
                    
                    // å°è¯•ä¿å­˜åˆ°äº‘ç«¯æ•°æ®ä¸­
                    if (this.cloudManager.isConnected) {
                        const data = await this.cloudManager.getData();
                        data.publicConfig = publicConfig;
                        await this.cloudManager.saveData(data);
                    }
                    
                    console.log('å…¬å¼€é…ç½®å·²ä¿å­˜');
                } catch (error) {
                    console.error('ä¿å­˜å…¬å¼€é…ç½®å¤±è´¥ï¼š', error);
                }
            }

            // ä¿å­˜é…ç½®åˆ°JSONæ–‡ä»¶
            async saveConfigToFile(config) {
                try {
                    // ç”±äºæµè§ˆå™¨å®‰å…¨é™åˆ¶ï¼Œæˆ‘ä»¬æ— æ³•ç›´æ¥å†™å…¥æ–‡ä»¶
                    // ä½†æˆ‘ä»¬å¯ä»¥æä¾›ä¸‹è½½é“¾æ¥
                    const configStr = JSON.stringify(config, null, 2);
                    const blob = new Blob([configStr], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    
                    // åˆ›å»ºä¸‹è½½é“¾æ¥
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = 'cloud-config.json';
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    
                    console.log('é…ç½®æ–‡ä»¶å·²ç”Ÿæˆï¼Œè¯·å°†cloud-config.jsonæ”¾åœ¨æœåŠ¡å™¨æ ¹ç›®å½•');
                } catch (error) {
                    console.error('ä¿å­˜é…ç½®æ–‡ä»¶å¤±è´¥ï¼š', error);
                }
            }

            saveConfig() {
                const binUrl = document.getElementById('binUrl').value.trim();
                const secretKey = document.getElementById('secretKey').value.trim();

                if (!binUrl || !secretKey) {
                    this.showMessage('è¯·å¡«å†™å®Œæ•´çš„é…ç½®ä¿¡æ¯ï¼', 'error');
                    return;
                }

                this.cloudManager.setConfig(binUrl, secretKey);
                this.showMessage('é…ç½®å·²ä¿å­˜ï¼', 'success');
                this.updateCloudStatus();
            }

            updateCloudStatus() {
                const statusElement = document.getElementById('connectionStatus');
                const cloudStatusElement = document.getElementById('cloudStatus');
                
                if (this.cloudManager.isConnected) {
                    statusElement.innerHTML = '<span class="status-icon">ğŸŸ¢</span><span class="status-text">å·²è¿æ¥</span>';
                    cloudStatusElement.textContent = 'ğŸŒ äº‘ç«¯æ¨¡å¼';
                } else {
                    statusElement.innerHTML = '<span class="status-icon">ğŸ”´</span><span class="status-text">æœªè¿æ¥</span>';
                    cloudStatusElement.textContent = 'ğŸ’¾ æœ¬åœ°æ¨¡å¼';
                }
            }

            // è€ƒè¯•ç®¡ç†æ–¹æ³•
            createExam() {
                const examName = document.getElementById('examName').value.trim();
                const examCodesText = document.getElementById('examCodes').value.trim();

                if (!examName) {
                    this.showMessage('è¯·è¾“å…¥è€ƒè¯•åç§°ï¼', 'error');
                    return;
                }

                if (!examCodesText) {
                    this.showMessage('è¯·è¾“å…¥å…è®¸çš„è€ƒå·ï¼', 'error');
                    return;
                }

                const allowedCodes = examCodesText.split('\n').map(code => code.trim()).filter(code => code);
                
                if (allowedCodes.length === 0) {
                    this.showMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„è€ƒå·ï¼', 'error');
                    return;
                }

                const newExam = {
                    id: Date.now(),
                    name: examName,
                    questions: [],
                    allowedCodes: allowedCodes,
                    isPublished: false,
                    createdAt: new Date().toISOString()
                };

                this.exams.push(newExam);
                this.saveData();
                this.displayExams();
                this.showMessage('è€ƒè¯•åˆ›å»ºæˆåŠŸï¼', 'success');

                // æ¸…ç©ºè¡¨å•
                document.getElementById('examName').value = '';
                document.getElementById('examCodes').value = '';
            }

            deleteExam() {
                if (!this.selectedExamId) {
                    this.showMessage('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè€ƒè¯•ï¼', 'error');
                    return;
                }

                const exam = this.exams.find(e => e.id === this.selectedExamId);
                if (!exam) {
                    this.showMessage('è€ƒè¯•ä¸å­˜åœ¨ï¼', 'error');
                    return;
                }

                // æ£€æŸ¥æ˜¯å¦æœ‰è€ƒè¯•ç»“æœ
                const examResults = this.results.filter(result => result.examId === this.selectedExamId);
                const hasResults = examResults.length > 0;

                let confirmMessage = 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè€ƒè¯•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼';
                if (hasResults) {
                    confirmMessage += `\n\næ³¨æ„ï¼šè¯¥è€ƒè¯•æœ‰ ${examResults.length} æ¡è€ƒè¯•ç»“æœï¼Œåˆ é™¤è€ƒè¯•å°†åŒæ—¶åˆ é™¤æ‰€æœ‰ç›¸å…³ç»“æœï¼`;
                }

                if (confirm(confirmMessage)) {
                    // åˆ é™¤è€ƒè¯•
                    this.exams = this.exams.filter(exam => exam.id !== this.selectedExamId);
                    
                    // åˆ é™¤ç›¸å…³çš„è€ƒè¯•ç»“æœ
                    if (hasResults) {
                        this.results = this.results.filter(result => result.examId !== this.selectedExamId);
                    }
                    
                    this.saveData();
                    this.displayExams();
                    this.displayResults(); // æ›´æ–°ç»“æœæ˜¾ç¤º
                    this.displayAvailableExams(); // æ›´æ–°å­¦ç”Ÿç«¯æ˜¾ç¤º
                    this.updateCurrentExamInfo();
                    
                    if (hasResults) {
                        this.showMessage(`è€ƒè¯•å’Œ ${examResults.length} æ¡ç›¸å…³ç»“æœå·²åˆ é™¤ï¼`, 'success');
                    } else {
                        this.showMessage('è€ƒè¯•åˆ é™¤æˆåŠŸï¼', 'success');
                    }
                }
            }

            publishExam() {
                if (!this.selectedExamId) {
                    this.showMessage('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè€ƒè¯•ï¼', 'error');
                    return;
                }

                const exam = this.exams.find(e => e.id === this.selectedExamId);
                if (exam) {
                    exam.isPublished = true;
                    this.saveData();
                    this.displayExams();
                    this.displayAvailableExams(); // æ›´æ–°å­¦ç”Ÿç«¯æ˜¾ç¤º
                    this.updateCurrentExamInfo();
                    this.showMessage('è€ƒè¯•å‘å¸ƒæˆåŠŸï¼', 'success');
                }
            }

            unpublishExam() {
                if (!this.selectedExamId) {
                    this.showMessage('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè€ƒè¯•ï¼', 'error');
                    return;
                }

                const exam = this.exams.find(e => e.id === this.selectedExamId);
                if (exam) {
                    exam.isPublished = false;
                    this.saveData();
                    this.displayExams();
                    this.displayAvailableExams(); // æ›´æ–°å­¦ç”Ÿç«¯æ˜¾ç¤º
                    this.updateCurrentExamInfo();
                    this.showMessage('è€ƒè¯•å·²å–æ¶ˆå‘å¸ƒï¼', 'success');
                }
            }

            selectExam(examId) {
                this.selectedExamId = examId;
                this.updateCurrentExamInfo();
                this.displayQuestions();
            }

            updateCurrentExamInfo() {
                const infoElement = document.getElementById('currentExamInfo');
                const publishBtn = document.getElementById('publishExamBtn');
                const unpublishBtn = document.getElementById('unpublishExamBtn');
                const deleteBtn = document.getElementById('deleteExamBtn');

                if (!this.selectedExamId) {
                    infoElement.innerHTML = '<p>è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè€ƒè¯•</p>';
                    publishBtn.disabled = true;
                    unpublishBtn.disabled = true;
                    deleteBtn.disabled = true;
                    return;
                }

                const exam = this.exams.find(e => e.id === this.selectedExamId);
                if (exam) {
                    infoElement.innerHTML = `
                        <h4>${exam.name}</h4>
                        <p>é¢˜ç›®æ•°é‡ï¼š${exam.questions.length} é“</p>
                        <p>è€ƒå·èŒƒå›´ï¼š${exam.allowedCodes.join(', ')}</p>
                        <p>çŠ¶æ€ï¼š${exam.isPublished ? 'å·²å‘å¸ƒ' : 'æœªå‘å¸ƒ'}</p>
                    `;
                    publishBtn.disabled = exam.isPublished;
                    unpublishBtn.disabled = !exam.isPublished;
                    deleteBtn.disabled = false;
                }
            }

            displayExams() {
                const container = document.getElementById('examsList');
                if (this.exams.length === 0) {
                    container.innerHTML = '<p>æš‚æ— è€ƒè¯•</p>';
                    return;
                }

                container.innerHTML = this.exams.map(exam => `
                    <div class="exam-item ${this.selectedExamId === exam.id ? 'selected' : ''}" 
                         onclick="examSystem.selectExam(${exam.id})">
                        <h4>${exam.name}</h4>
                        <p>é¢˜ç›®ï¼š${exam.questions.length} é“</p>
                        <p>è€ƒå·ï¼š${exam.allowedCodes.join(', ')}</p>
                        <p>çŠ¶æ€ï¼š${exam.isPublished ? 'å·²å‘å¸ƒ' : 'æœªå‘å¸ƒ'}</p>
                    </div>
                `).join('');
            }

            displayQuestions() {
                const container = document.getElementById('questionsList');
                if (!this.selectedExamId) {
                    container.innerHTML = '<p>è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè€ƒè¯•</p>';
                    return;
                }

                const exam = this.exams.find(e => e.id === this.selectedExamId);
                if (!exam || exam.questions.length === 0) {
                    container.innerHTML = '<p>æš‚æ— é¢˜ç›®</p>';
                    return;
                }

                container.innerHTML = exam.questions.map((question, index) => `
                    <div class="question-item">
                        <div class="question-header">
                            <span class="question-number">é¢˜ç›® ${index + 1}</span>
                            <button class="btn btn-danger btn-sm" onclick="examSystem.deleteQuestion(${index})">åˆ é™¤</button>
                        </div>
                        <div class="question-content">${question.text}</div>
                        <div class="question-answer">æ­£ç¡®ç­”æ¡ˆï¼š${question.correctAnswer}</div>
                    </div>
                `).join('');
            }

            deleteQuestion(questionIndex) {
                if (!this.selectedExamId) return;

                const exam = this.exams.find(e => e.id === this.selectedExamId);
                if (exam && confirm('ç¡®å®šè¦åˆ é™¤è¿™é“é¢˜ç›®å—ï¼Ÿ')) {
                    exam.questions.splice(questionIndex, 1);
                    this.saveData();
                    this.displayQuestions();
                    this.updateCurrentExamInfo();
                    this.showMessage('é¢˜ç›®åˆ é™¤æˆåŠŸï¼', 'success');
                }
            }

            // é¢˜ç›®ç®¡ç†æ–¹æ³•
            addQuestion(event) {
                event.preventDefault();
                
                if (!this.selectedExamId) {
                    this.showMessage('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè€ƒè¯•ï¼', 'error');
                    return;
                }

                const questionText = document.getElementById('questionText').value.trim();
                const correctAnswer = document.getElementById('correctAnswer').value;

                if (!questionText || !correctAnswer) {
                    this.showMessage('è¯·å¡«å†™å®Œæ•´çš„é¢˜ç›®ä¿¡æ¯ï¼', 'error');
                    return;
                }

                const exam = this.exams.find(e => e.id === this.selectedExamId);
                if (exam) {
                    exam.questions.push({
                        text: questionText,
                        correctAnswer: correctAnswer
                    });
                    this.saveData();
                    this.displayQuestions();
                    this.updateCurrentExamInfo();
                    this.showMessage('é¢˜ç›®æ·»åŠ æˆåŠŸï¼', 'success');

                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('questionText').value = '';
                    document.getElementById('correctAnswer').value = '';
                }
            }

            downloadTemplate() {
                try {
                    console.log('å¼€å§‹ç”ŸæˆExcelæ¨¡æ¿...');
                    const data = [
                        ['åºå·', 'é¢˜ç›®', 'ç­”æ¡ˆ'],
                        ['1', 'ç¤ºä¾‹é¢˜ç›®1ï¼šè¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹é¢˜ç›®ï¼Œè¯·é€‰æ‹©æ­£ç¡®ç­”æ¡ˆ', 'é€šè¿‡'],
                        ['2', 'ç¤ºä¾‹é¢˜ç›®2ï¼šè¿™æ˜¯å¦ä¸€ä¸ªç¤ºä¾‹é¢˜ç›®ï¼Œè¯·é€‰æ‹©æ­£ç¡®ç­”æ¡ˆ', 'è‡ªè§'],
                        ['3', 'ç¤ºä¾‹é¢˜ç›®3ï¼šè¿™æ˜¯ç¬¬ä¸‰ä¸ªç¤ºä¾‹é¢˜ç›®ï¼Œè¯·é€‰æ‹©æ­£ç¡®ç­”æ¡ˆ', 'é™æµ'],
                        ['4', 'ç¤ºä¾‹é¢˜ç›®4ï¼šè¿™æ˜¯ç¬¬å››ä¸ªç¤ºä¾‹é¢˜ç›®ï¼Œè¯·é€‰æ‹©æ­£ç¡®ç­”æ¡ˆ', 'ä¸‹æ¶']
                    ];

                    console.log('æ¨¡æ¿æ•°æ®ï¼š', data);

                    const ws = XLSX.utils.aoa_to_sheet(data);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'é¢˜ç›®æ¨¡æ¿');

                    console.log('å¼€å§‹ä¸‹è½½æ–‡ä»¶...');
                    XLSX.writeFile(wb, 'é¢˜ç›®æ¨¡æ¿.xlsx');
                    this.showMessage('æ¨¡æ¿ä¸‹è½½æˆåŠŸï¼', 'success');
                } catch (error) {
                    console.error('ä¸‹è½½æ¨¡æ¿å¤±è´¥ï¼š', error);
                    this.showMessage('ä¸‹è½½æ¨¡æ¿å¤±è´¥ï¼š' + error.message, 'error');
                }
            }

            triggerFileInput() {
                document.getElementById('excelFileInput').click();
            }

            importExcel(event) {
                console.log('å¼€å§‹å¯¼å…¥Excelæ–‡ä»¶...');
                const file = event.target.files[0];
                if (!file) {
                    console.log('æ²¡æœ‰é€‰æ‹©æ–‡ä»¶');
                    return;
                }

                console.log('é€‰æ‹©çš„æ–‡ä»¶ï¼š', file.name, file.type);

                if (!this.selectedExamId) {
                    console.log('æ²¡æœ‰é€‰æ‹©è€ƒè¯•');
                    this.showMessage('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè€ƒè¯•ï¼', 'error');
                    return;
                }

                console.log('é€‰æ‹©çš„è€ƒè¯•IDï¼š', this.selectedExamId);

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        console.log('å¼€å§‹è§£æExcelæ–‡ä»¶...');
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        console.log('Excelå·¥ä½œè¡¨ï¼š', workbook.SheetNames);
                        
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        console.log('è§£æçš„æ•°æ®ï¼š', jsonData);

                        if (jsonData.length < 2) {
                            throw new Error('Excelæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼Œè‡³å°‘éœ€è¦2è¡Œæ•°æ®ï¼ˆæ ‡é¢˜è¡Œ+æ•°æ®è¡Œï¼‰');
                        }

                        const exam = this.exams.find(e => e.id === this.selectedExamId);
                        if (!exam) {
                            this.showMessage('è€ƒè¯•ä¸å­˜åœ¨ï¼', 'error');
                            return;
                        }

                        console.log('æ‰¾åˆ°è€ƒè¯•ï¼š', exam.name);

                        let importedCount = 0;
                        for (let i = 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            console.log(`å¤„ç†ç¬¬${i+1}è¡Œï¼š`, row);
                            
                            if (row.length >= 3 && row[1] && row[2]) {
                                const questionText = row[1].toString().trim();
                                const answer = row[2].toString().trim();
                                console.log(`é¢˜ç›®ï¼š${questionText}, ç­”æ¡ˆï¼š${answer}`);

                                if (questionText && ['é€šè¿‡', 'è‡ªè§', 'é™æµ', 'ä¸‹æ¶'].includes(answer)) {
                                    exam.questions.push({
                                        text: questionText,
                                        correctAnswer: answer
                                    });
                                    importedCount++;
                                    console.log(`æˆåŠŸæ·»åŠ é¢˜ç›® ${importedCount}`);
                                } else {
                                    console.log('é¢˜ç›®æˆ–ç­”æ¡ˆæ ¼å¼ä¸æ­£ç¡®ï¼Œè·³è¿‡');
                                }
                            } else {
                                console.log('è¡Œæ•°æ®ä¸å®Œæ•´ï¼Œè·³è¿‡');
                            }
                        }

                        console.log(`æ€»å…±å¯¼å…¥ ${importedCount} é“é¢˜ç›®`);

                        if (importedCount > 0) {
                            this.saveData();
                            this.displayQuestions();
                            this.updateCurrentExamInfo();
                            this.showMessage(`æˆåŠŸå¯¼å…¥ ${importedCount} é“é¢˜ç›®ï¼`, 'success');
                        } else {
                            this.showMessage('æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„é¢˜ç›®æ•°æ®ï¼è¯·æ£€æŸ¥Excelæ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚', 'error');
                        }

                    } catch (error) {
                        console.error('å¯¼å…¥Excelå¤±è´¥ï¼š', error);
                        this.showMessage('å¯¼å…¥å¤±è´¥ï¼š' + error.message, 'error');
                    }
                };
                
                reader.onerror = (error) => {
                    console.error('æ–‡ä»¶è¯»å–å¤±è´¥ï¼š', error);
                    this.showMessage('æ–‡ä»¶è¯»å–å¤±è´¥ï¼', 'error');
                };
                
                reader.readAsArrayBuffer(file);

                // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
                event.target.value = '';
            }

            // ç»“æœç®¡ç†æ–¹æ³•
            displayResults() {
                const container = document.getElementById('resultsList');
                if (this.results.length === 0) {
                    container.innerHTML = '<p>æš‚æ— è€ƒè¯•ç»“æœ</p>';
                    return;
                }

                // æŒ‰è€ƒè¯•åˆ†ç»„æ˜¾ç¤ºç»“æœ
                const resultsByExam = {};
                this.results.forEach(result => {
                    const exam = this.exams.find(e => e.id === result.examId);
                    const examName = exam ? exam.name : 'æœªçŸ¥è€ƒè¯•';
                    if (!resultsByExam[examName]) {
                        resultsByExam[examName] = [];
                    }
                    resultsByExam[examName].push(result);
                });

                container.innerHTML = Object.keys(resultsByExam).map(examName => {
                    const examResults = resultsByExam[examName];
                    const exam = this.exams.find(e => e.name === examName);
                    
                    // è®¡ç®—å¹³å‡åˆ†
                    const totalScore = examResults.reduce((sum, result) => sum + result.score, 0);
                    const averageScore = (totalScore / examResults.length).toFixed(1);
                    
                    // è®¡ç®—æ¯é“é¢˜çš„æ­£ç¡®ç‡
                    const questionAccuracy = this.calculateQuestionAccuracy(exam, examResults);
                    
                    return `
                        <div class="exam-results">
                            <div class="exam-header">
                                <h4>${examName}</h4>
                                <button class="btn btn-info btn-sm" onclick="examSystem.showDetailedAnalysis('${examName}')">è¯¦ç»†åˆ†æ</button>
                            </div>
                            <div class="exam-stats">
                                <div class="stat-item">
                                    <div class="stat-label">å‚è€ƒäººæ•°</div>
                                    <div class="stat-value">${examResults.length}äºº</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">å¹³å‡åˆ†</div>
                                    <div class="stat-value average-score">${averageScore}åˆ†</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">é¢˜ç›®æ­£ç¡®ç‡</div>
                                    <div class="stat-value question-accuracy">${questionAccuracy}%</div>
                                </div>
                            </div>
                            <div class="results-list">
                                ${examResults.map(result => `
                                    <div class="result-item">
                                        <div class="result-info">
                                            <span class="student-name">${result.studentName}</span>
                                            <span class="student-id">å­¦å·ï¼š${result.studentId}</span>
                                            <span class="exam-code">è€ƒå·ï¼š${result.examCode}</span>
                                            <span class="score">å¾—åˆ†ï¼š${result.score}/${result.totalQuestions}</span>
                                        </div>
                                        <div class="result-time">${new Date(result.submitTime).toLocaleString()}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // è®¡ç®—æ¯é“é¢˜çš„æ­£ç¡®ç‡
            calculateQuestionAccuracy(exam, examResults) {
                if (!exam || !exam.questions || exam.questions.length === 0 || examResults.length === 0) {
                    return '0.0';
                }

                let totalCorrectAnswers = 0;
                let totalQuestions = exam.questions.length * examResults.length;

                exam.questions.forEach((question, questionIndex) => {
                    const correctAnswer = question.correctAnswer;
                    examResults.forEach(result => {
                        // ç¡®ä¿ answers æ˜¯æ•°ç»„æ ¼å¼
                        let studentAnswer;
                        if (Array.isArray(result.answers)) {
                            studentAnswer = result.answers[questionIndex];
                        } else if (result.answers && typeof result.answers === 'object') {
                            studentAnswer = result.answers[questionIndex];
                        } else {
                            studentAnswer = null;
                        }

                        if (studentAnswer === correctAnswer) {
                            totalCorrectAnswers++;
                        }
                    });
                });

                const accuracy = (totalCorrectAnswers / totalQuestions * 100).toFixed(1);
                return accuracy;
            }

            // è®¡ç®—æ¯é“é¢˜çš„æ­£ç¡®ç‡ï¼ˆè¿”å›æ•°ç»„ï¼‰
            calculateQuestionAccuracies(exam, examResults) {
                if (!exam || !exam.questions || exam.questions.length === 0 || examResults.length === 0) {
                    return [];
                }

                return exam.questions.map((question, questionIndex) => {
                    let correctCount = 0;
                    const totalStudents = examResults.length;

                    examResults.forEach(result => {
                        // ç¡®ä¿ answers æ˜¯æ•°ç»„æ ¼å¼
                        let studentAnswer;
                        if (Array.isArray(result.answers)) {
                            studentAnswer = result.answers[questionIndex];
                        } else if (result.answers && typeof result.answers === 'object') {
                            studentAnswer = result.answers[questionIndex];
                        } else {
                            studentAnswer = null;
                        }

                        if (studentAnswer === question.correctAnswer) {
                            correctCount++;
                        }
                    });

                    const accuracy = (correctCount / totalStudents * 100).toFixed(1);
                    return accuracy;
                });
            }

            // è¯¦ç»†åˆ†æåŠŸèƒ½
            showDetailedAnalysis(examName) {
                const exam = this.exams.find(e => e.name === examName);
                if (!exam) {
                    this.showMessage('è€ƒè¯•ä¸å­˜åœ¨ï¼', 'error');
                    return;
                }

                const examResults = this.results.filter(result => result.examId === exam.id);
                if (examResults.length === 0) {
                    this.showMessage('è¯¥è€ƒè¯•æš‚æ— ç»“æœï¼', 'error');
                    return;
                }

                // åˆ›å»ºåˆ†æå¼¹çª—
                this.createAnalysisModal(exam, examResults);
            }

            createAnalysisModal(exam, results) {
                // è®¡ç®—æ¯é“é¢˜çš„æ­£ç¡®ç‡
                const questionAccuracies = this.calculateQuestionAccuracies(exam, results);
                
                // åˆ›å»ºæ¨¡æ€æ¡†
                const modal = document.createElement('div');
                modal.className = 'analysis-modal';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>${exam.name} - è¯¦ç»†åˆ†æ</h3>
                            <button class="close-btn" onclick="this.closest('.analysis-modal').remove()">Ã—</button>
                        </div>
                        <div class="modal-body">
                            <div class="analysis-actions">
                                <button class="btn btn-primary" onclick="examSystem.exportAnalysisData('${exam.name}')">å¯¼å‡ºæ•°æ®</button>
                            </div>
                            <div class="analysis-table-container">
                                <table class="analysis-table">
                                    <thead>
                                        <tr>
                                            <th>é¢˜ç›®</th>
                                            <th>æ­£ç¡®ç­”æ¡ˆ</th>
                                            <th>æ­£ç¡®ç‡</th>
                                            ${results.map(result => `<th>${result.studentName}</th>`).join('')}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${exam.questions.map((question, index) => `
                                            <tr>
                                                <td class="question-cell">é¢˜ç›®${index + 1}ï¼š${question.text}</td>
                                                <td class="correct-answer">${question.correctAnswer}</td>
                                                <td class="question-accuracy-cell">${questionAccuracies[index]}%</td>
                                                ${results.map(result => {
                                                    const studentAnswer = result.answers[index] || 'æœªç­”';
                                                    const isCorrect = studentAnswer === question.correctAnswer;
                                                    return `<td class="student-answer ${isCorrect ? 'correct' : 'incorrect'}">${studentAnswer}</td>`;
                                                }).join('')}
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);
            }

            // å¯¼å‡ºåˆ†ææ•°æ®
            exportAnalysisData(examName) {
                const exam = this.exams.find(e => e.name === examName);
                if (!exam) {
                    this.showMessage('è€ƒè¯•ä¸å­˜åœ¨ï¼', 'error');
                    return;
                }

                const examResults = this.results.filter(result => result.examId === exam.id);
                if (examResults.length === 0) {
                    this.showMessage('è¯¥è€ƒè¯•æš‚æ— ç»“æœï¼', 'error');
                    return;
                }

                try {
                    // è®¡ç®—æ¯é“é¢˜çš„æ­£ç¡®ç‡
                    const questionAccuracies = this.calculateQuestionAccuracies(exam, examResults);
                    
                    // å‡†å¤‡å¯¼å‡ºæ•°æ®
                    const exportData = [
                        ['é¢˜ç›®', 'æ­£ç¡®ç­”æ¡ˆ', 'æ­£ç¡®ç‡', ...examResults.map(result => result.studentName)]
                    ];

                    exam.questions.forEach((question, index) => {
                        const row = [
                            `é¢˜ç›®${index + 1}ï¼š${question.text}`,
                            question.correctAnswer,
                            `${questionAccuracies[index]}%`,
                            ...examResults.map(result => {
                                const studentAnswer = result.answers[index] || 'æœªç­”';
                                return studentAnswer;
                            })
                        ];
                        exportData.push(row);
                    });

                    // ä½¿ç”¨SheetJSå¯¼å‡º
                    const ws = XLSX.utils.aoa_to_sheet(exportData);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'é¢˜ç›®åˆ†æ');

                    XLSX.writeFile(wb, `${examName}_é¢˜ç›®åˆ†æ.xlsx`);
                    this.showMessage('æ•°æ®å¯¼å‡ºæˆåŠŸï¼', 'success');
                } catch (error) {
                    console.error('å¯¼å‡ºå¤±è´¥ï¼š', error);
                    this.showMessage('å¯¼å‡ºå¤±è´¥ï¼š' + error.message, 'error');
                }
            }

            clearResults() {
                if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰è€ƒè¯•ç»“æœå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                    this.results = [];
                    this.saveData();
                    this.displayResults();
                    this.showMessage('ç»“æœæ¸…ç©ºæˆåŠŸï¼', 'success');
                }
            }

            // æ˜¾ç¤ºå­¦ç”Ÿç«¯å¯ç”¨è€ƒè¯•
            displayAvailableExams() {
                const container = document.getElementById('availableExams');
                if (!container) return;

                // åªæ˜¾ç¤ºå·²å‘å¸ƒçš„è€ƒè¯•
                const publishedExams = this.exams.filter(exam => exam.isPublished);
                
                if (publishedExams.length === 0) {
                    container.innerHTML = '<p>æš‚æ— å¯ç”¨è€ƒè¯•</p>';
                    return;
                }

                container.innerHTML = publishedExams.map(exam => `
                    <div class="exam-item">
                        <h4>${exam.name}</h4>
                        <p>é¢˜ç›®æ•°é‡ï¼š${exam.questions.length} é“</p>
                        <p>è€ƒå·èŒƒå›´ï¼š${exam.allowedCodes.join(', ')}</p>
                        <p>çŠ¶æ€ï¼šå·²å‘å¸ƒ</p>
                    </div>
                `).join('');
            }

            // é¢æ¿æ˜¾ç¤º
            showPanel(panelName) {
                // éšè—æ‰€æœ‰é¢æ¿
                document.querySelectorAll('.panel').forEach(panel => {
                    panel.classList.remove('active');
                });

                // æ˜¾ç¤ºæŒ‡å®šé¢æ¿
                if (panelName === 'cloudConfig') {
                    document.getElementById('cloudConfigPanel').classList.add('active');
                } else if (panelName === 'admin') {
                    document.getElementById('adminPanel').classList.add('active');
                } else if (panelName === 'student') {
                    document.getElementById('studentPanel').classList.add('active');
                    this.displayAvailableExams(); // æ˜¾ç¤ºå­¦ç”Ÿç«¯å¯ç”¨è€ƒè¯•
                } else if (panelName === 'results') {
                    document.getElementById('resultsPanel').classList.add('active');
                }

                // æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.getElementById(panelName + 'Btn').classList.add('active');
            }

            // å…¶ä»–æ–¹æ³•ä¿æŒä¸åŸç³»ç»Ÿç›¸åŒ...
            // ï¼ˆè¿™é‡Œçœç•¥äº†å…¶ä»–æ–¹æ³•çš„å®ç°ï¼Œå®é™…ä½¿ç”¨æ—¶éœ€è¦å®Œæ•´å¤åˆ¶ï¼‰

            // æ˜¾ç¤ºæ¶ˆæ¯
            showMessage(message, type = 'info') {
                // åˆ›å»ºæ¶ˆæ¯å…ƒç´ 
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}`;
                messageDiv.textContent = message;
                
                // æ·»åŠ åˆ°é¡µé¢
                document.body.appendChild(messageDiv);
                
                // 3ç§’åè‡ªåŠ¨ç§»é™¤
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.parentNode.removeChild(messageDiv);
                    }
                }, 3000);
            }

            // æœ¬åœ°å­˜å‚¨æ–¹æ³•ï¼ˆé™çº§ä½¿ç”¨ï¼‰
            loadExams() {
                const data = localStorage.getItem('exams');
                return data ? JSON.parse(data) : [];
            }

            saveExams() {
                localStorage.setItem('exams', JSON.stringify(this.exams));
            }

            loadResults() {
                const data = localStorage.getItem('results');
                return data ? JSON.parse(data) : [];
            }

            saveResults() {
                localStorage.setItem('results', JSON.stringify(this.results));
            }
        }

        // åˆå§‹åŒ–ç³»ç»Ÿ
        document.addEventListener('DOMContentLoaded', () => {
            window.examSystem = new CloudExamSystem();
        });
    </script>

</body>
</html>
